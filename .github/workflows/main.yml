name: Build and push docker

on:
  push:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v2
    
    - name: Build Spring app
      run: ./gradlew bootjar
        
    - name: Login into docker registry
      uses: docker/login-action@v2.1.0
      with:
        username: 1grzyb1
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Build and push Docker for backend
      uses: docker/build-push-action@v4.0.0
      with:
        context: .
        push: true
        tags: 1grzyb1/odyseja:latest
    
    - name: Build and push Docker for frontend
      uses: docker/build-push-action@v4.0.0
      with:
        context: ./odyseja-ui
        push: true
        tags: 1grzyb1/odyseja-frontend:latest

    - uses: alex-ac/github-action-ssh-docker-compose@master
      name: Deploy to dev environment
      with:
        ssh_host: 5.9.161.246
        ssh_private_key: ${{ secrets.DEPLOY_PRIVATE_KEY }}
        ssh_user: ${{ secrets.DEPLOY_USERNAME }}
        docker_compose_prefix: dev
        docker_compose_filename: deployment/docker-compose.yml
